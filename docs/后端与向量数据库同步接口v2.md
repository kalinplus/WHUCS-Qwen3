### 流的名称

```
REDIS_STREAM_NAME: str = "rag_sync_stream"
```



### 简介

根据我们的代码实现，后端（生产者）放入Redis Stream的消息，本质上是一个**包含特定键的JSON字符串**。`process_messages_batch`函数定义了消费者对这个JSON的“期望”。

---



### 一、核心数据结构（必需）

您的消费者代码明确要求每个JSON对象必须包含以下三个顶级键：

```json
{
  "source_id": "...",
  "content": "...",
  "metadata": { ... }
}
```

1.  **`source_id` (字符串, 必需)**
    *   **作用**：作为向量数据库中每个条目的**唯一标识符 (ID)**。这是实现更新（upsert）和删除操作的基石。
    *   **来源**：必须是源数据库中该条数据的**主键**。例如，`events`表中的`id`，`users`表中的`uuid`等。如果数据来源是多个表，主键可能重复，此时添加**表名**作为前缀；来源是多个库，则添加库名。

2.  **`content` (字符串, 必需)**
    *   **作用**：这是需要被**向量化（Embedding）**的主要文本内容。模型将读取这段文本来理解其语义。
    *   **来源**：由原始数据的多个字段组合而成的、对LLM友好的自然语言文本。例如：“活动名称：夏季编程马拉松。活动描述：一个为期24小时的编程挑战赛，旨在提升团队协作和快速开发能力。”

3.  **`metadata` (JSON对象, 必需)**
    *   **作用**：这是提升RAG系统能力的关键！它存储了所有**用于过滤和提供附加上下文**的“元信息”。这部分内容**不会**被向量化，但会和向量一起存储。==***有什么给什么就可以，我这边都是直接存起来，和具体有哪些没关系。***==
    *   **来源**：原始数据中除了`content`之外的所有有用字段。

---



### 二、元信息（Metadata）设计的黄金法则

**黄金法则：任何您将来可能希望用来筛选（Filter）检索结果的字段，都应该放进`metadata`里。**

想象一下您未来会问系统什么样的问题：
*   “查找一下**技术部**发布的关于**Python**的**最新**活动” -> 需要`department`，`tags`，`created_at`字段。
*   “张三的个人介绍是什么？” -> 需要`author_name`或`member_id`字段。

---



### 三、推荐的元信息内容（具体示例）

==***其实有什么给什么就可以，我这边都是直接存起来，和具体有哪些没关系。***==

对于您的社团管理系统，一个设计良好的`metadata`对象应该包含以下内容：

| 字段名             | 类型       | 作用与说明                                                 | 示例值                                                       |
| :----------------- | :--------- | :--------------------------------------------------------- | :----------------------------------------------------------- |
| **`source_type`**  | 字符串     | **[强烈推荐]** 数据的来源类型，用于大范围过滤。            | `"event"`, `"announcement"`, `"member_profile"`, `"static_rule"` |
| **`created_at`**   | 字符串     | 原始数据的创建时间（ISO 8601格式）。用于按时间排序或过滤。 | `"2025-06-28T10:00:00Z"`                                     |
| **`author`**       | 字符串     | 信息发布者的ID或名称。                                     | `"user_id_123"`, `"admin"`                                   |
| **`department`**   | 字符串     | 所属部门。                                                 | `"tech_dept"`, `"finance_dept"`                              |
| **`tags`**         | 字符串数组 | 关键词标签，用于多维度过滤。                               | `["python", "recruitment", "competition"]`                   |
| **`title`**        | 字符串     | 原始文章或事件的标题。                                     | `"关于举办第一届社团编程挑战赛的通知"`                       |
| **`url`**          | 字符串     | 指向原始数据在Web应用中的链接，便于溯源。                  | `"/events/12345"`                                            |
| **`original_doc`** | 字符串     | （仅用于静态文档）原始文件名。                             | `"club_rules_v3.pdf"`                                        |

---



### 四、完整消息示例

下面是几个在您的场景下，后端应该生成的具体消息JSON：

#### 示例1：发布一个新活动

```json
{
  "source_id": "event_12345",
  "content": "活动通知：将举办一场关于深度学习入门的分享会。主讲人：李四。时间：下周五晚7点。地点：活动室301。欢迎所有对AI感兴趣的同学参加！",
  "metadata": {
    "source_type": "event",
    "title": "深度学习入门分享会",
    "author": "user_id_456",
    "department": "tech_dept",
    "created_at": "2025-07-05T12:30:00Z",
    "tags": ["ai", "deep_learning", "workshop"],
    "url": "/events/12345"
  }
}
```

#### 示例2：一个成员更新了他的个人简介

```json
{
  "source_id": "user_profile_789",
  "content": "大家好，我是王五，来自宣传部。我擅长使用Photoshop和Premiere进行海报设计和视频剪辑。希望能和大家一起为社团创作出更多精彩的作品。",
  "metadata": {
    "source_type": "member_profile",
    "title": "王五的个人简介",
    "author": "user_id_789",
    "department": "publicity_dept",
    "created_at": "2025-06-20T09:00:00Z",
    "tags": ["design", "photoshop", "video_editing"],
    "url": "/members/789"
  }
}
```

#### 示例3：从静态的规章制度PDF中提取的一条规则

```json
{
  "source_id": "rules_v3_chunk_5",
  "content": "关于经费报销：所有超过100元的单次采购需提前向财务部提交申请，经批准后方可执行。报销时需提供正式发票，并在活动结束后一周内完成。",
  "metadata": {
    "source_type": "static_rule",
    "title": "经费报销规定",
    "original_doc": "社团规章制度v3.pdf",
    "section": "财务管理",
    "page_number": 5
  }
}
```

