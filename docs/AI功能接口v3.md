# 基本功能

hkl：基本功能中除了首页新闻总结 + 辅助功能中 RAG 部分

mzh：基本功能中新闻总结 + 扩展功能 + 辅助功能中维护调试

### **架构和职责划分**

首先，我们明确一下三个主要部分的角色：

1.  **Vue3 (前端)**:
    *   负责所有用户界面的展示和交互。
    *   调用 **Go 后端** 获取业务数据（如社团列表、新闻列表）。
    *   与 **FastAPI 后端** 直接交互，以实现低延迟的 AI 聊天功能。

2.  **Go (服务器后端)**:
    *   **核心业务逻辑**：负责用户管理、社团信息管理、新闻/活动发布等所有 CRUD (增删改查) 操作。
    *   **数据库交互**: 与主数据库（如 PostgreSQL, MySQL）交互，存储所有业务数据。
    *   **RAG 智能搜索**: 实现复杂的搜索逻辑，包括调用向量数据库和倒排索引，然后将检索到的内容发送给 FastAPI 进行总结。
    *   **AI 任务编排**: 对于非实时的 AI 任务（如首页新闻总结、搜索结果总结），由 Go 后端调用 FastAPI 后端来完成。

3.  **FastAPI (大模型后端)**:
    *   **vLLM 服务封装**: 封装对 vLLM 推理服务的调用，提供简洁的 HTTP 接口。
    *   **专职 AI 推理**: 只负责接收文本、调用模型、返回结果。它不处理任何业务逻辑或数据库操作。
    *   **提供原子化的 AI 能力**: 如文本总结、问答聊天等。

---

### **接口定义**

下面是详细的接口设计。

#### **一、 Go 后端接口 (Vue -> Go)**

这些接口用于前端获取核心业务数据和触发复杂的 AI 搜索。

**1. 首页 AI 新闻总结**

* **功能描述**: 前端进入欢迎页面时调用，获取由 AI 总结的近期新闻和趋势。

* **Endpoint**: `GET /api/v1/dashboard/summary`

* **认证**: `Required (JWT)`

* **请求参数**: 无

* **成功响应 (200 OK)**:

  ```json
  {
    "code": 200,
    "message": "Success",
    "data": {
      "summary_text": "AI总结的近期热点：上周，计算机学院成功举办了年度编程大赛，吸引了百余名学生参与。同时，机器人社团的新成员招募活动也已圆满结束，社团动态趋势显示技术类社团关注度持续上升..."
    }
  }
  ```

  *   **内部流程**:
      1.  Go 后端从数据库获取最近7天的新闻和活动。
      2.  Go 后端调用 **FastAPI 的 `/summarize` 接口**，将新闻文本发送过去。
      3.  FastAPI 使用 Qwen3-8B 模型进行总结，并将结果返回给 Go。
      4.  Go 后端将总结结果返回给前端。

**2. RAG 智能搜索**

* **功能描述**: 用户在搜索框输入内容后调用此接口。返回 AI 总结和详细的搜索结果列表。

* **Endpoint**: `GET /api/v1/search`

* **认证**: `Optional`

* **请求参数**:

  *   `q` (string, required): 用户的搜索查询。
  *   `page` (int, optional, default: 1): 页码。
  *   `limit` (int, optional, default: 10): 每页数量。

* **成功响应 (200 OK)**:

  ```json
  {
    "code": 200,
    "message": "Success",
    "data": {
      "ai_summary": "根据您的搜索“编程比赛”，我们为您总结了以下关键信息：计算机学院近期举办了年度编程大赛，旨在提升学生的实践能力。同时，CodeCrafters 社团每周都有相关的技术分享活动，是学习编程的好去处。",
      "results": [
        {
          "type": "news",
          "id": 101,
          "title": "我院成功举办年度编程大赛",
          "snippet": "本次比赛吸引了来自不同年级的百余名学生参与，展示了高超的编程技巧...",
          "url": "/news/101",
          "timestamp": "2024-10-26T10:00:00Z"
        },
        {
          "type": "club",
          "id": 12,
          "name": "CodeCrafters 编程社",
          "description": "一个专注于算法和软件开发的社团，每周都有技术分享和项目实践。",
          "avatar": "/images/club_12.png",
          "url": "/club/12"
        }
      ],
      "pagination": {
        "total": 5,
        "page": 1,
        "limit": 10
      }
    }
  }
  ```

  *   **内部流程**:
      1.  Go 后端接收到查询 `q`。
      2.  **执行 RAG**:
          *   **关键词检索**: 通过倒排索引（如 Elasticsearch, MeiliSearch 或数据库全文搜索）查找包含关键词的文档。
          *   **相似性检索**: 将查询 `q` 转换为向量，在向量数据库（如 Milvus, ChromaDB）中查找相似的文档。
          *   **结果融合与排序**: 合并两路结果并进行排序。
      3.  Go 后端将排序后的 **Top-K 文档** 和用户查询 `q` 发送给 **FastAPI 的 `/summarize/search` 接口** 进行总结。
      4.  Go 后端整合 AI 总结和详细结果列表，返回给前端。

---

#### **二、 FastAPI 大模型后端接口**

这些接口被 Go 后端或 Vue 前端直接调用，以执行纯粹的 AI 任务。

**1. 文本总结接口 (Go -> FastAPI)**

* **功能描述**: 接收一段或多段文本，生成总结。用于搜索结果总结。

* **Endpoint**: `POST /summarize`

* **请求体**:

  ```json
  {
    "documents": [
      "新闻1的全文内容...",
      "新闻2的全文内容..."
    ],
    "query": "可选的总结侧重点，例如用户的搜索查询",
    "max_tokens": 200
  }
  ```

* **成功响应 (200 OK)**:

  ```json
  {
    "summary": "这是由 Qwen3-8B 生成的总结文本。"
  }
  ```

**2. AI 聊天接口 (Vue -> FastAPI)**

* **功能描述**: 用于右侧的 AI 聊天框。前端直接调用此接口，以获得低延迟的实时问答体验。

* **Endpoint**: `POST /chat`

* **请求体**:

  ```json
  {
    "messages": [
      { "role": "system", "content": "你是一个社团管理助手，请根据知识库友好地回答用户问题。" },
      { "role": "user", "content": "你好，我想找一个关于人工智能的社团。" }
    ],
    "user_id": "user12345", // 可选，用于追踪上下文或个性化
    "stream": false // 是否使用流式响应，建议为 true 以提升体验
  }
  ```

* **成功响应 (200 OK)**:

  * **非流式 (`stream: false`)**:

    ```json
    {
      "response": {
        "role": "assistant",
        "content": "当然！我推荐您关注“AI探索者协会”，他们每周都有关于最新AI技术的分享会，非常有趣。"
      },
      "usage": { // 来自 vLLM 的 token 使用情况
        "prompt_tokens": 50,
        "completion_tokens": 80,
        "total_tokens": 130
      }
    }
    ```

  * **流式 (`stream: true`)**:
    响应将是 `text/event-stream` 类型。前端需要使用 `EventSource` API 来接收。

    ```
    data: {"delta": {"content": "当然！"}}
    data: {"delta": {"content": "我推荐您"}}
    data: {"delta": {"content": "关注“AI探索者协会”"}}
    data: {"delta": {"content": "..."}}
    data: [DONE]
    ```

    - **内部流程增强**:
      1. 当 /chat 接口被调用时，提取用户最新的问题。
      2. **调用 Embedding 模型**，将问题转换为向量。
      3. **查询向量数据库**，检索出最相关的文档（新闻、社团介绍等）。
      4. **构建增强的 Prompt**: 将检索到的上下文和用户的原始问题一起组合成一个新的 prompt。
      5. 将这个**增强后的 prompt**（包含在 messages 结构中）发送给 vLLM 的 Qwen3-8B 模型。
    - **结论**: 接口定义本身**无需改变**，但其**内部实现**必须包含 RAG 逻辑。FastAPI 需要能够访问向量数据库和 Embedding 模型。

### **设计考量与总结**

1.  **认证 (Authentication)**:
    *   Go 后端的业务接口应使用 **JWT (JSON Web Tokens)** 进行保护。用户登录后，前端在每个请求头中携带 Token。
    *   FastAPI 的聊天接口可以设计为公开访问，也可以通过在 Nginx 或 FastAPI 中间件中验证与 Go 后端共享的 JWT 来保护，这取决于你是否希望匿名用户也能使用聊天功能。

2.  **关注点分离**:
    *   该架构清晰地分离了业务逻辑（Go）和 AI 推理（FastAPI）。如果未来需要更换大模型或升级 vLLM，只需修改 FastAPI 部分，Go 和 Vue 不受影响。
    *   如果需要更换数据库或业务规则，也只影响 Go 部分。

3.  **性能**:
    *   AI 聊天由前端直连 FastAPI，避免了经过 Go 中转的额外延迟。
    *   对于耗时较长的 RAG 搜索，Go 后端可以采用异步处理，先返回一个任务ID，前端稍后轮询结果，以避免长时间的请求阻塞。

这套接口设计为你提供了一个健壮且可扩展的起点，能够很好地支持你所描述的所有功能。



# 拓展功能

当然！基于你现有的技术栈和架构，有很多易于实现且业务价值极高的功能可以添加。核心思路是：**充分利用已经部署的 Qwen3-8B 模型，将其应用到社团管理的各个环节，以提升效率和用户体验。**

以下是我推荐的三个功能，并附有详细的理由和实现说明。

---

### **功能一：个性化社团与活动智能推荐**

#### **功能描述**

在用户（特别是新生）的个人主页或一个专门的“发现”页面，系统根据用户的个人信息（如学院、专业、兴趣标签）和行为数据（如浏览过的社团、参加过的活动），由 AI 生成一段推荐语和推荐列表。

**示例界面展示：**

> “Hi [张三]同学，根据你对「人工智能」和「户外运动」的兴趣，我们为你推荐以下社团和活动：
>
> 1.  **AI探索者协会**: 这里是技术爱好者的聚集地，非常符合你的专业方向。他们下周有一个关于大模型的分享会。
> 2.  **山鹰户外社**: 如果你想在学习之余放松身心，他们的周末徒步活动不容错过。
> 3.  **近期活动推荐**: 「AI技术应用讲座」..."

#### **业务价值**

*   **解决“选择困难症”**: 新生面对几十上百个社团时往往无从下手，个性化推荐能极大地降低他们的决策成本，提高社团的匹配度和加入率。
*   **提升用户粘性**: 一个“懂你”的系统会让用户感觉更受重视，从而更愿意频繁使用平台。
*   **促进活动参与**: 智能推荐活动能确保用户不会错过他们可能感兴趣的内容，提高活动的参与度和影响力。

#### **实现思路**

这是一个非常适合 LLM 的任务，因为它擅长于基于上下文进行推理和生成自然语言。

1. **数据收集 (Go 后端)**:

   *   Go 后端从数据库获取用户的个人资料（如专业、填写的兴趣标签）。
   *   获取用户近期的行为数据（如浏览历史、点赞）。
   *   获取所有社团的描述、标签和近期活动列表。

2. **构建 Prompt (Go 后端)**:

   * Go 后端将这些信息整合成一个结构化的 Prompt。例如：

     ```
     你是一个大学社团的智能推荐助手。请根据以下用户信息和社团列表，为他推荐3个最合适的社团，并用友好、个性化的语气解释推荐理由。
     
     # 用户信息
     - 姓名: 张三
     - 学院: 计算机科学与技术
     - 兴趣: 人工智能, 户外运动, 摄影
     
     # 社团列表
     - 名称: AI探索者协会, 描述: 专注于前沿AI技术..., 标签: 技术, AI, 编程
     - 名称: 山鹰户外社, 描述: 每周末组织徒步、攀岩..., 标签: 户外, 运动, 探险
     - ...
     ```

3. **调用 AI (Go -> FastAPI)**:

   *   Go 后端调用 FastAPI 的一个新接口，如 `/recommend/clubs`，将构建好的 Prompt 发送过去。

4. **前端展示 (Vue3)**:

   *   前端请求 Go 后端的 `/api/v1/user/recommendations` 接口，获取 AI 生成的推荐语和列表，并美观地展示出来。

#### **接口示例 (Go 后端)**

* **Endpoint**: `GET /api/v1/user/recommendations`

* **认证**: `Required (JWT)`

* **成功响应 (200 OK)**:

  ```json
  {
    "code": 200,
    "message": "Success",
    "data": {
      "recommendation_text": "Hi 张三同学...", // AI 生成的推荐语
      "recommended_items": [
        {"type": "club", "id": 15, "name": "AI探索者协会", ...},
        {"type": "club", "id": 23, "name": "山鹰户外社", ...},
        {"type": "event", "id": 201, "title": "AI技术应用讲座", ...}
      ]
    }
  }
  ```

---

### **功能二：AI 内容创作助手 (活动宣传/新闻稿)**

#### **功能描述**

在社团管理员发布新活动或新闻的界面，提供一个“AI 生成”按钮。管理员只需输入几个关键词或一句话描述（如“本周五晚7点，A栋101教室，举办Python入门讲座，面向全校师生”），AI 就能自动生成一篇格式完整、语言生动的宣传文案或新闻稿。

#### **业务价值**

*   **降低管理成本**: 大大减轻了社团管理员的内容创作负担，特别是对于不擅长写作的同学，能有效提高工作效率。
*   **提升内容质量**: AI 生成的文案通常比匆忙写出的内容更规范、更吸引人，有助于提升社团的专业形象和活动的吸引力。
*   **促进内容更新频率**: 由于创作变得简单，社团会更愿意发布动态，保持平台的活跃度。

#### **实现思路**

这是一个典型的文本生成任务，实现起来非常直接。

1. **前端交互 (Vue3)**:

   *   在内容发布表单旁设置一个“AI 生成”按钮和一个简单的输入框。
   *   用户输入关键词后，前端可以直接调用 **FastAPI 的 `/generate/content` 接口**。这样做延迟更低，体验更好。

2. **构建 Prompt (FastAPI 后端)**:

   * FastAPI 接收到关键词和内容类型（如“活动宣传”、“新闻稿”）。

   * 构建 Prompt，例如：

     ```
     你是一位专业的社团宣传文案专家。请根据以下要点，生成一篇生动有趣的活动宣传稿，字数在150字左右。
     
     # 要点
     - 活动: Python入门讲座
     - 时间: 本周五晚7点
     - 地点: A栋101教室
     - 面向人群: 全校师生
     - 特点: 零基础友好, 现场有互动
     ```

3. **返回并填充 (Vue3)**:

   *   FastAPI 调用 Qwen3-8B 生成文案后，将结果返回给前端。
   *   前端将返回的文本自动填充到活动描述或新闻稿的富文本编辑器中，供管理员审阅和修改。

#### **接口示例 (FastAPI 后端)**

* **Endpoint**: `POST /generate/content`

* **请求体**:

  ```json
  {
    "keywords": "本周五晚7点，A栋101教室，举办Python入门讲座，面向全校师生",
    "content_type": "event_promotion", // "news_article"
    "tone": "enthusiastic" // "formal"
  }
  ```

* **成功响应 (200 OK)**:

  ```json
  {
    "generated_text": "【编程之夜，Python奇遇记等你来开启！】\n\n同学们，还在为编程入门而烦恼吗？机会来啦！本周五晚7点，我们将在A栋101教室举办一场超燃的Python入门讲座！无论你是文科生还是理科生，只要你对代码的世界充满好奇，这里就是你的起点。我们承诺零基础友好，现场还有大神带你互动实践。快叫上你的小伙伴，一起来解锁编程新技能吧！"
  }
  ```

# 辅助功能

和GO实现数据同步

### **3.3 RAG 数据同步接口 (内部调用)**

#### **POST /upsert-document**

- **功能描述**: 新增或更新一个文档到向量数据库。
- **调用方**: Go Backend (在数据库 Create/Update 操作后触发)
- **请求体**:

```json
{
  "document_id": "news_101",
  "text": "需要被向量化的原始文本...",
  "metadata": {"type": "news", "title": "...", "timestamp": "..."}
}
```

- **成功响应 (200 OK)**: {"status": "success", "document_id": "news_101"}

#### **DELETE /delete-document/{document_id}**

- **功能描述**: 从向量数据库中删除一个文档。
- **调用方**: Go Backend (在数据库 Delete 操作后触发)
- **路径参数**: document_id (string, required)
- **成功响应 (200 OK)**: {"status": "success", "document_id": "news_101"}

#### Embedding 模型从哪来

在 FastAPI 服务中**独立加载和管理一个专门的 Embedding 模型**（如 M3E, BGE 等）。这样可以和主 LLM 解耦，方便独立升级。

### 维护调试

为了方便维护和调试，FastAPI 后端最好提供一些管理接口。

- **功能需求**: 检查服务健康状况、了解当前加载的模型信息。
- **建议新增接口**:
  - **GET /health**: 一个简单的健康检查接口。它可以检查与 vLLM 和向量数据库的连接是否正常。如果一切正常，返回 {"status": "ok"} 和 HTTP 200。这对于自动化部署和监控至关重要。
  - **GET /info 或 GET /models**: 返回当前 FastAPI 服务加载的模型信息，例如：

```json
{
  "main_llm_provider": "vLLM",
  "embedding_model_name": "moka-ai/m3e-base",
  "vector_db_provider": "ChromaDB",
  "vector_db_collection": "club_management_rag"
}
```

# 额外事项

虽然文档提到了认证，但我们可以具体化。

- **问题**: Vue 直接调用 FastAPI 的 /chat 和 /generate/content 接口，如何防止被滥用？
- **建议**:
  - **API Key 认证**: 为 FastAPI 的所有接口增加一个简单的 API Key 认证机制。前端在调用时，在请求头中加入 X-API-Key 字段。Nginx 或 FastAPI 的中间件可以负责校验这个 Key。这个 Key 可以是 Go 后端在用户登录后下发给前端的，或者是所有前端共享的一个静态 Key。
  - **速率限制**: 在 Nginx 或 FastAPI 中间件层面，对来自同一 IP 或同一用户的请求进行速率限制，防止恶意攻击或爬虫。